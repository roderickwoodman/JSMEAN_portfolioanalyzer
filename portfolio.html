<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Portfolio</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>
	<script type="text/javascript">  
	    $(document).ready(function() {

	 		// var symbolData = [];
	 		var database = [];

		    // The event listener for the file upload
		    document.getElementById('txtFileUpload').addEventListener('change', upload, false);
		 
		    // Method that checks that the browser supports the HTML5 File API
		    function browserSupportFileUpload() {
		        var isCompatible = false;
		        if (window.File && window.FileReader && window.FileList && window.Blob) {
		        isCompatible = true;
		        }
		        return isCompatible;
		    }
		 
		    // Method that reads and processes the selected file
		    function upload(evt) {
		    if (!browserSupportFileUpload()) {
		        alert('The File APIs are not fully supported in this browser!');
		        } else {
		            var data = null;
		            var file = evt.target.files[0];
		            var reader = new FileReader();
		            reader.readAsText(file);
		            reader.onload = function(event) {
		                var csvData = event.target.result;
		                data = $.csv.toArrays(csvData);
		                if (data && data.length > 0) {
		                    // alert('Imported -' + data.length + '- rows successfully!');

		                    var newSymbols = extractPositionsFromFileData(data);
		                    for (var n=0; n<newSymbols.length; n++) {
		                    	// console.log("newSymbols["+n+"]: "+newSymbols[n]);
	                    		if (database.length == 0) {
	                    			database.push(new Array(newSymbols[n][0], parseInt(newSymbols[n][1])));                    	
	                    		}
	                    		else {
			                    	for (var d=0; d<database.length; d++) {
			                    		if (database[d][0] == newSymbols[n][0]) {
			                    			console.log("DBmod: "+newSymbols[n][1]+" "+database[d][1]);
			                    			database[d][1] = parseInt(database[d][1]) + parseInt(newSymbols[n][1]);
			                    			break;
			                    		}
			                    		else if (d == database.length - 1) {
			                    			database.push(new Array(newSymbols[n][0], parseInt(newSymbols[n][1])));     
					                    	break;
			                    		}
			                    	}
	                    		}
		                    }
		                    updateDatabaseHtml();

		                } else {
		                    alert('No data to import!');
		                }
		            };
		            reader.onerror = function() {
		                alert('Unable to read ' + file.fileName);
		            };
		        }
		    }

		    function extractPositionsFromFileData(fileData) {
		    	var matchResults = [];
		    	var foundFirstSymbol = false;
		    	var thisIsFirstSymbol = false;
		    	var anotherValidSymbol = false;
		    	var qtyColumn = 0;
		    	var match = false;
		    	for (var i=0; i<fileData.length; i++) 
		    	{
		    		match = fileData[i][0].trim().toUpperCase().match(/^[A-Z]/);
		    		if (match != null) 
		    		{
			    		if (fileData[i][0].trim() == "Symbol") {
			    			thisIsFirstSymbol = true;
			    			foundFirstSymbol = true;
			    			for (var q=0; q<fileData[i].length-1; q++) {
			    				if (fileData[i][q].trim().toUpperCase() == "QTY") {
			    					qtyColumn = q;
			    					break;
			    				}
			    			}
			    		}
			    		else if (foundFirstSymbol == true) 
			    		{	
			    			symbolToAdd = [];
				    		if (thisIsFirstSymbol == true) {
				    			thisIsFirstSymbol = false;
				    			matchResults.push(new Array(fileData[i][0], fileData[i][q]));
				    		}
				    		else {
				    			anotherValidSymbol = true;
				    			for (var j=0; j<fileData[i].length-1; j++) {
				    				if (fileData[i][j].length == 0) {
				    					anotherValidSymbol = false;
				    					break;
				    				}
				    			}
				    			if (anotherValidSymbol == true) {
					    			matchResults.push(new Array(fileData[i][0], fileData[i][q]));
								}
				    		}
				    	}
					}
		    	}
		    	return matchResults;
		    }

		    function updateDatabaseHtml () {
		    	// console.log("current database...");
                $('#allData').html("");
                for (var n=0; n<database.length; n++) {
                	// console.log("database["+n+"]: "+database[n]);
                    $('#allData').append("<tr><td>"+database[n][0]+"</td><td>"+database[n][1]+"</td><td></td><td></td></tr>");
                }
            }


			function dbgPrintArray (arr) {
		    	for (var k=0; k<arr.length; k++) {
			    	console.log("["+k+"]: "+arr[k]);
			    }			
			}

		});
	</script>
</head>
<body>
	<div id="dvImportSegments" class="fileupload ">
	    <fieldset>
	        <legend>Upload your CSV File</legend>
	            <input type="file" name="File Upload" id="txtFileUpload" accept=".csv" />
	   	</fieldset>
	</div>
	<table>
		<thead>
			<tr>
				<th>Symbol</th>
				<th>Qty</th>
				<th>Quote</th>
				<th>Value</th>
			</tr>
		</thead>
		<tbody id="allData">
		</tbody>
	</table>
</body>
</html>